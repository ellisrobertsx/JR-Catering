{% extends "base.html" %}

{% block content %}
<div class="menu-container">
    <div class="section-title">
        <span class="line"></span>
        <h2>Your Bookings</h2>
        <span class="line"></span>
    </div>
    
    {% if 'user_id' not in session %}
        <div class="login-prompt">
            <p>Please log in to view and manage your bookings.</p>
            <a href="{{ url_for('login') }}" class="btn primary-btn">Login</a>
        </div>
    {% else %}
        <!-- Add New Booking Button -->
        <div class="booking-actions" style="text-align: center; margin: 2rem 0;">
            <button class="btn primary-btn" onclick="toggleNewBookingForm()">Add New Booking</button>
        </div>

        <!-- New Booking Form (hidden by default) -->
        <div id="new-booking-form" class="form-container" style="display: none;">
            <h2>Make a New Booking</h2>
            <form id="new-booking-form-element" onsubmit="submitNewBooking(event)">
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone:</label>
                    <input type="tel" id="phone" name="phone" required>
                </div>
                <div class="form-group">
                    <label for="date">Date:</label>
                    <input type="date" id="date" name="date" required min="">
                </div>
                <div class="form-group">
                    <label for="time">Time:</label>
                    <select id="time" name="time" required>
                        <option value="">Select a time</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="guests">Number of Guests:</label>
                    <input type="number" id="guests" name="guests" min="1" max="20" required>
                </div>
                <div class="form-group">
                    <label for="special_requests">Special Requests (Optional):</label>
                    <textarea id="special_requests" name="special_requests"></textarea>
                </div>
                <button type="submit" class="btn save-btn">Make Booking</button>
                <button type="button" class="btn cancel-btn" onclick="toggleNewBookingForm()">Cancel</button>
            </form>
        </div>

        <!-- Existing Bookings -->
        <div class="bookings-grid">
            {% if bookings %}
                {% for booking in bookings %}
                    <div class="booking-card" data-booking-id="{{ booking.id }}">
                        <div class="booking-display" id="booking-display-{{ booking.id }}">
                            <div class="booking-info" id="booking-info-{{ booking.id }}">
                                <p><strong>Booking ID:</strong> {{ booking.id }}</p>
                                <p><strong>Date:</strong> {{ booking.date }}</p>
                                <p><strong>Time:</strong> {{ booking.time }}</p>
                                <p><strong>Number of Guests:</strong> {{ booking.guests }}</p>
                            </div>
                            <div class="booking-actions">
                                <button class="btn edit-btn" onclick="toggleEditForm({{ booking.id }})">Edit Booking</button>
                                <button class="btn cancel-btn" onclick="deleteBooking({{ booking.id }})">Cancel Booking</button>
                            </div>
                        </div>
                        
                        <!-- Edit form (hidden by default) -->
                        <div class="edit-form" id="edit-form-{{ booking.id }}" style="display: none;">
                            <form onsubmit="updateBooking(event, {{ booking.id }})">
                                <div class="form-group">
                                    <label for="name-{{ booking.id }}">Name:</label>
                                    <input type="text" id="name-{{ booking.id }}" name="name" value="{{ booking.name }}" required>
                                </div>
                                <div class="form-group">
                                    <label for="email-{{ booking.id }}">Email:</label>
                                    <input type="email" id="email-{{ booking.id }}" name="email" value="{{ booking.email }}" required>
                                </div>
                                <div class="form-group">
                                    <label for="phone-{{ booking.id }}">Phone:</label>
                                    <input type="tel" id="phone-{{ booking.id }}" name="phone" value="{{ booking.phone }}" required>
                                </div>
                                <div class="form-group">
                                    <label for="date-{{ booking.id }}">Date:</label>
                                    <input type="date" id="date-{{ booking.id }}" name="date" value="{{ booking.date }}" required>
                                </div>
                                <div class="form-group">
                                    <label for="time-{{ booking.id }}">Time:</label>
                                    <select id="time-{{ booking.id }}" name="time" required>
                                        <option value="">Select a time</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="guests-{{ booking.id }}">Number of Guests:</label>
                                    <input type="number" id="guests-{{ booking.id }}" name="guests" value="{{ booking.guests }}" min="1" max="20" required>
                                </div>
                                <div class="booking-actions">
                                    <button type="submit" class="btn save-btn">Save Changes</button>
                                    <button type="button" class="btn cancel-btn" onclick="toggleEditForm({{ booking.id }})">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="no-bookings">You have no current bookings.</p>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
// Set minimum date to tomorrow
function setMinDate(inputId) {
    const dateInput = document.getElementById(inputId);
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1); // Allow booking only from tomorrow onwards
    const yyyy = tomorrow.getFullYear();
    const mm = String(tomorrow.getMonth() + 1).padStart(2, '0');
    const dd = String(tomorrow.getDate()).padStart(2, '0');
    dateInput.min = `${yyyy}-${mm}-${dd}`;
}

// Generate time slots in 5-minute intervals
function generateTimeSlots(selectId) {
    const timeSelect = document.getElementById(selectId);
    timeSelect.innerHTML = '<option value="">Select a time</option>';
    
    // Restaurant hours (adjust these as needed)
    const startHour = 11; // 11 AM
    const endHour = 22;   // 10 PM
    
    for (let hour = startHour; hour < endHour; hour++) {
        for (let minute = 0; minute < 60; minute += 5) {
            const formattedHour = String(hour).padStart(2, '0');
            const formattedMinute = String(minute).padStart(2, '0');
            const timeString = `${formattedHour}:${formattedMinute}`;
            
            const option = document.createElement('option');
            option.value = timeString;
            option.textContent = timeString;
            timeSelect.appendChild(option);
        }
    }
}

// Initialize date and time inputs when form is shown
function toggleNewBookingForm() {
    const form = document.getElementById('new-booking-form');
    if (form.style.display === 'none') {
        form.style.display = 'block';
        setMinDate('date');
        generateTimeSlots('time');
    } else {
        form.style.display = 'none';
    }
}

// Initialize date and time inputs for edit form
function toggleEditForm(bookingId) {
    const selectedDisplay = document.getElementById(`booking-display-${bookingId}`);
    const selectedEditForm = document.getElementById(`edit-form-${bookingId}`);

    if (selectedDisplay && selectedEditForm) {
        if (selectedEditForm.style.display === 'none' || selectedEditForm.style.display === '') {
            selectedDisplay.style.display = 'none';
            selectedEditForm.style.display = 'block';
            setMinDate(`date-${bookingId}`);
            generateTimeSlots(`time-${bookingId}`);
        } else {
            selectedEditForm.style.display = 'none';
            selectedDisplay.style.display = 'block';
        }
    }
}

// Validate date and time on form submission
document.querySelector('#new-booking-form-element').addEventListener('submit', function(event) {
    const selectedDate = new Date(document.getElementById('date').value);
    const selectedTime = document.getElementById('time').value;
    const now = new Date();
    
    // Combine date and time for comparison
    const [hours, minutes] = selectedTime.split(':');
    selectedDate.setHours(parseInt(hours), parseInt(minutes));
    
    if (selectedDate <= now) { // Ensure booking is at least a day in advance
        event.preventDefault();
        alert('Please select a future date and time.');
    }
});

// Call these functions when the page loads
document.addEventListener('DOMContentLoaded', function() {
    setMinDate('date');
    generateTimeSlots('time');
});

function updateBooking(event, bookingId) {
    event.preventDefault();
    
    const nameValue = document.getElementById(`name-${bookingId}`).value;
    const emailValue = document.getElementById(`email-${bookingId}`).value;
    const phoneValue = document.getElementById(`phone-${bookingId}`).value;
    const dateValue = document.getElementById(`date-${bookingId}`).value;
    const timeValue = document.getElementById(`time-${bookingId}`).value;
    const guestsValue = document.getElementById(`guests-${bookingId}`).value;

    const bookingData = {
        name: nameValue,
        email: emailValue,
        phone: phoneValue,
        date: dateValue,
        time: timeValue,
        guests: parseInt(guestsValue)
    };

    fetch(`/edit_booking/${bookingId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(bookingData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'Failed to update booking');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const infoDiv = document.getElementById(`booking-info-${bookingId}`);
            infoDiv.innerHTML = `
                <p><strong>Booking ID:</strong> ${bookingId}</p>
                <p><strong>Date:</strong> ${bookingData.date}</p>
                <p><strong>Time:</strong> ${bookingData.time}</p>
                <p><strong>Number of Guests:</strong> ${bookingData.guests}</p>
            `;
            toggleEditForm(bookingId);
            alert('Booking updated successfully!');
        }
    })
    .catch(error => {
        console.error('Update failed:', error);
        alert(`Error updating booking: ${error.message}`);
    });
}

function deleteBooking(bookingId) {
    if (confirm('Are you sure you want to cancel this booking?')) {
        fetch(`/delete_booking/${bookingId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                // Remove the booking card from the page
                const bookingCard = document.querySelector(`.booking-card[data-booking-id="${bookingId}"]`);
                if (bookingCard) {
                    bookingCard.remove();
                    
                    // Check if there are any bookings left
                    const remainingBookings = document.querySelectorAll('.booking-card');
                    if (remainingBookings.length === 0) {
                        // If no bookings left, show "no bookings" message
                        const bookingsContainer = document.querySelector('.bookings-grid');
                        bookingsContainer.innerHTML = '<p class="no-bookings">You have no current bookings.</p>';
                    }
                }
                alert('Booking cancelled successfully!');
            } else {
                alert('Failed to cancel booking. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error cancelling booking. Please try again.');
        });
    }
}

function submitNewBooking(event) {
    event.preventDefault();
    
    const nameValue = document.getElementById('name').value;
    const emailValue = document.getElementById('email').value;
    const phoneValue = document.getElementById('phone').value;
    const dateValue = document.getElementById('date').value;
    const timeValue = document.getElementById('time').value;
    const guestsValue = document.getElementById('guests').value;
    const specialRequestsValue = document.getElementById('special_requests').value;

    // Debug logs
    console.log('Form Values:', {
        name: nameValue,
        email: emailValue,
        phone: phoneValue,
        date: dateValue,
        time: timeValue,
        guests: guestsValue,
        special_requests: specialRequestsValue
    });

    const bookingData = {
        name: nameValue,
        email: emailValue,
        phone: phoneValue,
        date: dateValue,
        time: timeValue,
        guests: parseInt(guestsValue),
        special_requests: specialRequestsValue
    };

    const submitButton = event.target.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.textContent = 'Creating booking...';

    fetch('/create_booking', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(bookingData)
    })
    .then(response => {
        console.log('Server Response Status:', response.status);
        return response.json().then(data => {
            if (!response.ok) {
                throw new Error(data.error || 'Failed to create booking');
            }
            return data;
        });
    })
    .then(data => {
        console.log('Server Response Data:', data);
        
        // Create new booking card
        const bookingsGrid = document.querySelector('.bookings-grid');
        const noBookingsMessage = document.querySelector('.no-bookings');
        
        if (noBookingsMessage) {
            noBookingsMessage.remove();
        }

        const newBookingCard = `
            <div class="booking-card" data-booking-id="${data.booking.id}">
                <div class="booking-display" id="booking-display-${data.booking.id}">
                    <div class="booking-info" id="booking-info-${data.booking.id}">
                        <p><strong>Booking ID:</strong> ${data.booking.id}</p>
                        <p><strong>Date:</strong> ${data.booking.date}</p>
                        <p><strong>Time:</strong> ${data.booking.time}</p>
                        <p><strong>Number of Guests:</strong> ${data.booking.guests}</p>
                    </div>
                    <div class="booking-actions">
                        <button class="btn edit-btn" onclick="toggleEditForm(${data.booking.id})">Edit Booking</button>
                        <button class="btn cancel-btn" onclick="deleteBooking(${data.booking.id})">Cancel Booking</button>
                    </div>
                </div>
                
                <!-- Add the edit form template -->
                <div class="edit-form" id="edit-form-${data.booking.id}" style="display: none;">
                    <form onsubmit="updateBooking(event, ${data.booking.id})">
                        <div class="form-group">
                            <label for="name-${data.booking.id}">Name:</label>
                            <input type="text" id="name-${data.booking.id}" name="name" value="${data.booking.name}" required>
                        </div>
                        <div class="form-group">
                            <label for="email-${data.booking.id}">Email:</label>
                            <input type="email" id="email-${data.booking.id}" name="email" value="${data.booking.email}" required>
                        </div>
                        <div class="form-group">
                            <label for="phone-${data.booking.id}">Phone:</label>
                            <input type="tel" id="phone-${data.booking.id}" name="phone" value="${data.booking.phone}" required>
                        </div>
                        <div class="form-group">
                            <label for="date-${data.booking.id}">Date:</label>
                            <input type="date" id="date-${data.booking.id}" name="date" value="${data.booking.date}" required>
                        </div>
                        <div class="form-group">
                            <label for="time-${data.booking.id}">Time:</label>
                            <input type="time" id="time-${data.booking.id}" name="time" value="${data.booking.time}" required>
                        </div>
                        <div class="form-group">
                            <label for="guests-${data.booking.id}">Number of Guests:</label>
                            <input type="number" id="guests-${data.booking.id}" name="guests" value="${data.booking.guests}" min="1" max="20" required>
                        </div>
                        <div class="booking-actions">
                            <button type="submit" class="btn save-btn">Save Changes</button>
                            <button type="button" class="btn cancel-btn" onclick="toggleEditForm(${data.booking.id})">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        bookingsGrid.insertAdjacentHTML('afterbegin', newBookingCard);
        toggleNewBookingForm(); // 
        document.getElementById('new-booking-form-element').reset(); 
        alert('Booking created successfully!');
    })
    .catch(error => {
        console.error('Booking Error:', error);
        alert(error.message || 'Error creating booking. Please try again.');
    })
    .finally(() => {
       
        submitButton.disabled = false;
        submitButton.textContent = 'Make Booking';
    });
}


</script>
{% endblock %}

